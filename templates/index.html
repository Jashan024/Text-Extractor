<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Extractor</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-inner">
            <div class="logo">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                    <polyline points="10 9 9 9 8 9"></polyline>
                </svg>
                <span>DataExtractor</span>
            </div>
            <div class="header-hint">Ctrl + Enter to extract</div>
        </div>
    </header>

    <main class="main">
        <!-- Input Section -->
        <section class="input-section">
            <div class="section-header">
                <h2>
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                    Paste Profile Data
                </h2>
                <button id="clear-btn" class="btn-ghost" onclick="clearAll()" title="Clear all">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                    Clear
                </button>
            </div>
            <div class="source-row">
                <label class="source-label" for="source-select">
                    <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="2" y1="12" x2="22" y2="12"></line>
                        <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                    </svg>
                    Source
                </label>
                <select id="source-select" class="source-select" onchange="updatePlaceholder()">
                    <option value="indeed" selected>üìã Indeed</option>
                    <option value="signalhire">üîç SignalHire</option>
                    <option value="linkedin_xray">üîó LinkedIn X-ray</option>
                </select>
            </div>
            <textarea id="input-text" placeholder="Paste structured profile text here...&#10;&#10;Example:&#10;Elizabeth Rupert&#10;Montandon, PA&#10;Relevant Work Experience&#10;Register&#10;The GIANT Company, 2025 - Present"></textarea>
            <div class="input-actions">
                <label class="append-toggle" title="Keep previous results and add new ones">
                    <input type="checkbox" id="append-check">
                    <span class="append-slider"></span>
                    <span class="append-label">Append to results</span>
                </label>
                <button id="extract-btn" class="btn-primary" onclick="extractData()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                    Extract Data
                </button>
            </div>
        </section>

        <!-- Stats Cards -->
        <section id="stats" class="stats hidden">
            <div class="stat-card">
                <div class="stat-icon people-icon">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                </div>
                <div class="stat-info">
                    <span class="stat-value" id="stat-people">0</span>
                    <span class="stat-label">People</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon location-icon">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                        <circle cx="12" cy="10" r="3"></circle>
                    </svg>
                </div>
                <div class="stat-info">
                    <span class="stat-value" id="stat-locations">0</span>
                    <span class="stat-label">Locations</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon title-icon">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
                        <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path>
                    </svg>
                </div>
                <div class="stat-info">
                    <span class="stat-value" id="stat-titles">0</span>
                    <span class="stat-label">Titles</span>
                </div>
            </div>
            <div class="stat-card stat-action">
                <button class="btn-success" onclick="downloadCSV()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    Download CSV
                </button>
            </div>
        </section>

        <!-- Batch Info -->
        <div id="batch-info" class="batch-info hidden"></div>

        <!-- Results Table -->
        <section id="results" class="results-section hidden">
            <div class="table-wrapper">
                <table id="results-table">
                    <thead>
                        <tr>
                            <th class="th-num">#</th>
                            <th class="th-name">Name</th>
                            <th class="th-location">Location</th>
                            <th class="th-titles">Title(s)</th>
                        </tr>
                    </thead>
                    <tbody id="results-body"></tbody>
                </table>
            </div>
        </section>

        <!-- Error -->
        <div id="error" class="error hidden"></div>
    </main>

    <script>
        let extractedPeople = [];
        let batchCount = 0;

        async function extractData() {
            const text = document.getElementById('input-text').value;
            const btn = document.getElementById('extract-btn');
            const results = document.getElementById('results');
            const stats = document.getElementById('stats');
            const error = document.getElementById('error');
            const batchInfo = document.getElementById('batch-info');
            const appendMode = document.getElementById('append-check').checked;

            if (!text.trim()) {
                error.textContent = 'Please enter some text first.';
                error.classList.remove('hidden');
                if (!appendMode) {
                    results.classList.add('hidden');
                    stats.classList.add('hidden');
                    batchInfo.classList.add('hidden');
                }
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '<svg class="spin" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-6.219-8.56"></path></svg> Extracting...';
            error.classList.add('hidden');

            try {
                const response = await fetch('/extract', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text, source: document.getElementById('source-select').value })
                });

                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.error || 'Extraction failed');
                }

                const data = await response.json();
                const newPeople = data.people;

                if (appendMode && extractedPeople.length > 0) {
                    // Append new people to existing results
                    extractedPeople = extractedPeople.concat(newPeople);
                    batchCount++;
                } else {
                    // Replace mode
                    extractedPeople = newPeople;
                    batchCount = 1;
                }

                renderTable(extractedPeople);

                // Calculate unique stats from accumulated data
                const uniqueNames = new Set(extractedPeople.map(p => p.name).filter(Boolean));
                const uniqueLocations = new Set(extractedPeople.map(p => p.location).filter(Boolean));
                const uniqueTitles = new Set(extractedPeople.flatMap(p => p.titles));

                // Animate stat counters
                animateCounter('stat-people', extractedPeople.length);
                animateCounter('stat-locations', uniqueLocations.size);
                animateCounter('stat-titles', uniqueTitles.size);

                stats.classList.remove('hidden');
                results.classList.remove('hidden');

                // Show batch info in append mode
                if (appendMode && batchCount > 1) {
                    batchInfo.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-2px"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"></path></svg> Batch ' + batchCount + ' \u2014 <strong>' + extractedPeople.length + ' profiles</strong> total' + (newPeople.length > 0 ? ' (+' + newPeople.length + ' new)' : '');
                    batchInfo.classList.remove('hidden');
                } else {
                    batchInfo.classList.add('hidden');
                }

                // In append mode, clear textarea for next paste
                if (appendMode) {
                    document.getElementById('input-text').value = '';
                    document.getElementById('input-text').focus();
                }

                // Smooth scroll to results
                stats.scrollIntoView({ behavior: 'smooth', block: 'start' });
            } catch (err) {
                error.textContent = err.message;
                error.classList.remove('hidden');
                if (!appendMode) {
                    results.classList.add('hidden');
                    stats.classList.add('hidden');
                    batchInfo.classList.add('hidden');
                }
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg> Extract Data';
            }
        }

        function animateCounter(id, target) {
            const el = document.getElementById(id);
            let current = 0;
            const step = Math.max(1, Math.floor(target / 20));
            const interval = setInterval(() => {
                current += step;
                if (current >= target) {
                    current = target;
                    clearInterval(interval);
                }
                el.textContent = current;
            }, 30);
        }

        function renderTable(people) {
            const tbody = document.getElementById('results-body');
            tbody.innerHTML = '';

            if (people.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = '<td colspan="4" class="empty-msg">No profiles found. Make sure the text follows the expected format.</td>';
                tbody.appendChild(tr);
                return;
            }

            people.forEach((person, index) => {
                const tr = document.createElement('tr');
                tr.style.animationDelay = `${index * 0.02}s`;
                tr.className = 'fade-in-row';

                const tdNum = document.createElement('td');
                tdNum.textContent = index + 1;
                tdNum.className = 'row-num';

                const tdName = document.createElement('td');
                tdName.className = 'cell-name';
                const nameSpan = document.createElement('span');
                nameSpan.className = 'name-text';
                nameSpan.textContent = person.name || '\u2014';
                tdName.appendChild(nameSpan);

                const tdLoc = document.createElement('td');
                tdLoc.className = 'cell-location';
                if (person.location) {
                    tdLoc.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="opacity:0.5;vertical-align:-2px;margin-right:4px"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>' + person.location;
                } else {
                    tdLoc.textContent = '\u2014';
                }

                const tdTitles = document.createElement('td');
                tdTitles.className = 'cell-titles';
                if (person.titles.length > 0) {
                    person.titles.forEach(title => {
                        const span = document.createElement('span');
                        span.className = 'title-tag';
                        span.textContent = title;
                        tdTitles.appendChild(span);
                    });
                } else {
                    tdTitles.innerHTML = '<span class="no-title">\u2014</span>';
                }

                tr.appendChild(tdNum);
                tr.appendChild(tdName);
                tr.appendChild(tdLoc);
                tr.appendChild(tdTitles);
                tbody.appendChild(tr);
            });
        }

        function downloadCSV() {
            if (extractedPeople.length === 0) return;

            const escapeCSV = (val) => {
                if (!val) return '';
                const str = String(val);
                if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                    return '"' + str.replace(/"/g, '""') + '"';
                }
                return str;
            };

            const rows = [['#', 'Name', 'Location', 'Title(s)']];
            extractedPeople.forEach((person, i) => {
                rows.push([
                    i + 1,
                    escapeCSV(person.name),
                    escapeCSV(person.location),
                    escapeCSV(person.titles.join('; '))
                ]);
            });

            const csv = rows.map(r => r.join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'extracted_data.csv';
            a.click();
            URL.revokeObjectURL(url);
        }

        function clearAll() {
            document.getElementById('input-text').value = '';
            document.getElementById('results').classList.add('hidden');
            document.getElementById('stats').classList.add('hidden');
            document.getElementById('error').classList.add('hidden');
            document.getElementById('batch-info').classList.add('hidden');
            extractedPeople = [];
            batchCount = 0;
            document.getElementById('input-text').focus();
        }

        function updatePlaceholder() {
            const source = document.getElementById('source-select').value;
            const ta = document.getElementById('input-text');
            if (source === 'signalhire') {
                ta.placeholder = 'Paste SignalHire search results here...\n\nExample:\n* S\nSusan Grimes\nDentist at\n__Shelburne Village Dentistry__\nShelburne, Vermont, United States\n37 years exp';
            } else if (source === 'linkedin_xray') {
                ta.placeholder = 'Paste LinkedIn X-ray (Google) search results here...\n\nExample:\nDana J. Ellis BS,RN - Registered Nurse at The University of ...\nLinkedIn \u00b7 Dana J. Ellis BS,RN\n90+ followers\nBurlington, Vermont, United States \u00b7 Med/Surg Resource Staff RN \u00b7 The University of Vermont Medical Center';
            } else {
                ta.placeholder = 'Paste structured profile text here...\n\nExample:\nElizabeth Rupert\nMontandon, PA\nRelevant Work Experience\nRegister\nThe GIANT Company, 2025 - Present';
            }
        }

        // Ctrl+Enter to extract
        document.getElementById('input-text').addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'Enter') extractData();
        });
    </script>
</body>
</html>
